#!/bin/bash

set -e -u

releasename="pr-$(cat concourse/.git/resource/pr)-$(head -c 6 concourse/.git/resource/base_sha)"

function cleanup {
    sleep 10
    helm delete "$releasename" --namespace "$releasename" || true
    kubectl delete --ignore-not-found=true namespace "$releasename"
}
trap cleanup EXIT

mkdir -p ~/.kube

if [ ! -f ~/.kube/config ]; then
  echo "$KUBE_CONFIG" > ~/.kube/config
fi

helm lint concourse
helm dependency update ./concourse
helm install \
  "$releasename" \
  ./concourse \
  --set=concourse.web.kubernetes.keepNamespaces=false \   # cleanup namespaces created by team secrets
  --namespace "$releasename" \
  --create-namespace
# TODO: actually poke concourse to see that it's up. For now this just ensures helm doesn't exit 1 when installing
